<!-- 
Tailwindのおまじない
cd frontend
npx tailwindcss -i ./css/style.css -o ./css//twind.css --watch
-->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="css/twind.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pattaya&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <title>日記作成｜ToryDory</title>
    <link rel="icon" href="image/marulogo.ico" />

    <script type="text/javascript" src="/js/general.js"></script>
    <script type="text/javascript" src="/js/api.js"></script>
    <script type="text/javascript" src="js/secret_key.js"></script>
  </head>
  <body class="bg-slate-200">
    <div id="header" class="relative h-[56px]xl:h-[72px]">
      <div>
        <div class="bg-[#8ECAE6] h-5 xl:h-6"></div>
        <div class="bg-[#219EBC] h-4 xl:h-5"></div>
        <div class="bg-[#126782] h-3 xl:h-4"></div>
        <div class="bg-[#023047] h-2 xl:h-3"></div>
      </div>
      <div
        class="items-center flex ml-1 mr-1 xl:ml-3 xl:mr-3 absolute top-1 xl:top-1 xl:left-0 w-full"
      >
        <img
          src="image\header_logo_1.svg"
          alt="ヘッダーロゴ"
          class="h-10 xl:h-12"
        />
        <h1
          class="text-4xl xl:text-5xl font-pattaya ml-1 xl:ml-2 pt-1 xl:pt-0 text-white"
        >
          ToryDory
        </h1>
        <img
          src="image\header_island.svg"
          alt="ヘッダー島"
          class="h-10 xl:h-12 ml-2 xl:ml-3"
        />
        <div id="my-image" class="ml-auto"></div>
        <div class="ml-2 w-fit mr-8">
          <h1
            id="welcome"
            class="text-[#023047] font-nsjp font-semibold text-xl mb-1"
          ></h1>
          <button
            onclick="logout()"
            class="bg-[#8ECAE6] border-2 border-white rounded text-[#023047] font-nsjp font-semibold pl-1 pr-1"
          >
            ログアウト
          </button>
        </div>
      </div>
    </div>
    <div
      id="main"
      class="mt-2 xl:mt-0 ml-0 xl:ml-28 mr-0 xl:mr-28 mb-6 xl:mb-8"
    >
      <div
        class="bg-[#8fc0a9] shadow-lg pb-6 xl:pb-20 mr-2 xl:mr-0 ml-2 xl:ml-0 mb-4 xl:mb-10 rounded-b"
      >
        <div class="xl:ml-4 xl:mr-4 pt-2 xl:pt-4">
          <div class="ml-2 xl:ml-4 mb-2 xl:mb-4">
            <h2
              class="text-[#023047] text-[170%] xl:text-[300%] font-pattaya h-8 xl:h-16"
            >
              Make ship's log
            </h2>
            <h4
              class="text-[#023047] text-[80%] xl:text-[150%] font-nsjp xl:font-medium"
            >
              日記作成
            </h4>
          </div>
          <div class="xl:ml-[10%] xl:mr-[10%]">
            <div class="relative mb-6 xl:mb-0">
              <img
                src="image/makelog_main.svg"
                alt="makelog"
                class="shadow-md ml-4 xl:ml-0 mr-4 xl:mr-0 xl:m-8 xl:mt-2 rounded border-4 border-white"
              />
              <div
                class="absolute top-0 xl:top-[22%] bottom-[70%] xl:bottom-[22%] right-0 xl:right-[6vw] left-[33vw] xl:left-auto scale-50 xl:scale-125"
              >
                <h3
                  class="font-nsjp font-semibold mb-2 xl:mb-2 text-2xl text-white"
                >
                  今日完了したタスク
                </h3>
                <div
                  id="donelist"
                  class="h-[50vw] xl:h-[85%] w-[75vw] xl:w-[20vw] p-2 overflow-y-scroll bg-white rounded"
                >
                  <!-- ここにタスク一覧が追加 -->
                </div>
              </div>
            </div>
            <div id="taskcommentDivcontainer">
              <!-- ここにタスクコメント一覧が追加 -->
            </div>
            <div class="flex items-baseline">
              <p
                class="font-nsjp font-semibold text-[#023047] xl:text-3xl ml-4 xl:ml-8 mb-1 xl:mb-3"
              >
                今日の日記
              </p>
              <button
                id="submit"
                class="shadow-md w-fit xl:w-fit p-[1%] xl:p-[0.1vw] pl-[4%] xl:pl-[1vw] pr-[4%] xl:pr-[1vw] pt-0 xl:mb-2 xl:ml-4 bg-[#FFB703] border-4 border-[#FB8500] xl:text-2xl font-nsjp font-semibold text-[#023047] rounded"
              >
                <div class="flex items-baseline">
                  <img
                    src="image/google-gemini.svg"
                    alt="gemini"
                    class="h-9"
                  /><span class="ml-1">で生成</span>
                </div>
              </button>
            </div>
            <div
              class="flex border-4 border-slate-600 shadow-md h-32 xl:h-80 bg-slate-300 ml-4 xl:ml-8 mr-4 xl:mr-8 xl:mb-8"
            >
              <div
                id="figureImage"
                class="bgimgpath bg-center bg-no-repeat bg-contain ml-auto mr-auto bg-[url('')] w-[50%]"
              >
                <div
                  class="flex flex-col h-full w-ful items-center text-center justify-center"
                >
                  <span
                    class="material-symbols-outlined !text-6xl mix-blend-overlay"
                    id="upload-button"
                  >
                    add_photo_alternate
                  </span>
                  <input
                    accept="image/*"
                    type="file"
                    id="diary-image-input"
                    name="img_path"
                  />
                </div>
                <!-- <img
                  src="image\IMG_7834.jpg"
                  alt=""
                  id="figureImage"
                  class="h-full object-contain ml-auto mr-auto"
                /> -->
              </div>
              <textarea
                name="todo1"
                id="output-area"
                class="shadow-md h-full xl:h-full w-full overflow-y-scroll"
              ></textarea>
            </div>
          </div>
        </div>
        <div
          class="text-center w-full xl:w-[30vw] ml-auto xl:ml-auto mr-auto xl:mr-auto mt-8 xl:mt-20"
        >
          <button
            class="shadow-md w-fit xl:w-fit p-[1%] xl:p-[0.1vw] pl-[4%] xl:pl-[2vw] pr-[4%] xl:pr-[2vw] pt-0 xl:pt-0 bg-[#FFB703] border-4 border-[#FB8500] xl:text-[1.5vw] font-nsjp font-semibold text-[#023047] rounded"
            onclick="savediary()"
          >
            保存
          </button>
        </div>
      </div>
      <div class="text-center xl:pb-0">
        <a href="index.html">
          <button
            class="w-fit xl:w-fit shadow-md p-[1%] xl:p-[0.1vw] pl-[4%] xl:pl-[1vw] pr-[4%] xl:pr-[1vw] pt-0 xl:pt-0 pb-0.5 bg-[#8ECAE6] border-4 border-[#FFFFFF] xl:text-[1.5vw] font-nsjp font-semibold text-[#023047] rounded"
          >
            ホームに戻る
          </button>
        </a>
      </div>
    </div>
    <div id="footer" class="flex items-center w-fit mx-auto mb-4">
      <img
        src="image/marulogo.svg"
        alt="marulogo"
        class="h-6 xl:h-8 mr-1 xl:mr-2"
      />
      <p class="text-center text-[#023047] font-nsjp text-[50%] xl:text-[100%]">
        ©2024 Nishibori Sorachi All rights reserved.
      </p>
    </div>
  </body>

  <script>
    if (!checkLogin()) {
      handleLoginError();
    }

    // ユーザー情報を取得
    getMeApi().then((data) => {
      console.log("data:", data);
      const welcomeH1 = document.getElementById("welcome");
      const icon = document.getElementById("my-image");
      welcomeH1.innerText = `${data.nickname}`;
      icon.innerHTML = `
        <img src="${API_HOST}${data.icon_img}" alt="アイコン画像" class="h-14 w-14 ml-auto rounded-full object-cover">
      `;
      // console.log(icon.src);
    });

    // 完了タスク一覧を取得
    getDonetaskslistApi().then((data) => {
      console.log(data);
      data.forEach((task) => {
        console.log(task.done_date);
        const donetaskDiv = document.createElement("li");
        const doneList = document.getElementById("donelist");
        donetaskDiv.setAttribute("class", "font-nsjp font-medium text-xl");
        donetaskDiv.setAttribute("id", "donelist" + `${task.id}`);
        //完了タスクのうちその日に完了したものを表示
        if (task.done_date == gettoday()) {
          const taskcommentDiv = document.createElement("div");
          const taskcommentDivcontainer = document.getElementById(
            "taskcommentDivcontainer"
          );
          //タスクテーブルから該当idのタイトルを取得
          const taskDetailUrl = `${API_HOST}/task/${task.id}`;
          getTaskDetailApi(task.id).then((data) => {
            donetaskDiv.innerHTML = `
            ${data.title}
            `;
            doneList.appendChild(donetaskDiv);
            console.log("data:", data.title);
            taskcommentDiv.innerHTML = `
            <div class="relative xl:static flex xl:items-center">
              <div
               id=${
                 "tasktitle" + task.id
               } class="h-8 xl:h-14 w-[200px] xl:w-[450px] bg-white ml-4 xl:ml-8 mr-2 xl:mr-2 mb-2 xl:mb-4"
              ><span class="text-2xl font-nsjp font-semibold text-[#023047] items-center justify-center flex h-full">${
                data.title
              }</span></div>
              <p
                class="absolute top-[10px] left-auto right-[90px] bottom-0 xl:static font-nsjp font-semibold text-[#023047] xl:text-2xl"
              >
                について
              </p>
            </div>
            <div
              class="h-24 xl:h-44 bg-white ml-4 xl:ml-8 mr-4 xl:mr-8 mb-4 xl:mb-8"
            >
              <textarea
                id=${"taxtarea" + task.id}
                class="border-4 border-slate-600 shadow-md h-full xl:h-full w-full xl:w-full"
              ></textarea>
            </div>
          `;
            taskcommentDivcontainer.appendChild(taskcommentDiv);
          });
        }
      });
    });

    //未実装:タスクコメント保存

    //日記画像プレビュー
    const previewImg = () => {
      const input = document.getElementById("diary-image-input");
      const figureImage = document.getElementById("figureImage");

      input.addEventListener("change", (event) => {
        // <1>
        const [file] = event.target.files;

        if (file) {
          figureImage.style.backgroundImage =
            "url(" + URL.createObjectURL(file) + ")";
        }
      });
    };
    previewImg();

    //日記を保存
    const savediary = () => {
      const diarytext = document.getElementById("output-area");
      const diarytextvalue = diarytext.value;
      if (!diarytextvalue) {
        megsDiv.innerText = "日記を入力してください";
        return;
      }
      const diaryImageInput = document.getElementById("diary-image-input");
      const date = gettoday();

      const diaryData = {
        date: date,
        main_text: diarytextvalue,
      };

      createDiaryApi(diaryData).then(async (data) => {
        console.log("data:", data.id);
        // 画像がある場合は、画像をアップロード
        if (diaryImageInput.files.length !== 0) {
          updateDiaryImageApi(data.id, diaryImageInput.files[0]);
          console.log(diaryImageInput.files[0]);
        }
        alert("日記を保存しました");
        location.href = "/alllogs.html";
      });
    };

    //天気API
    // APIのエンドポイント
    const apiUrl = "https://weather.tsukumijima.net/api/forecast/city/140010";
    let weathertext = "";

    // Fetch APIを使用してデータをリクエストする関数
    async function getWeatherForecast() {
      try {
        const response = await fetch(apiUrl, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        // レスポンスが正常に返ってきたか確認
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // JSONデータを取得
        const data = await response.json();

        // forecastの最初の要素のtelopをロギング
        if (data.forecasts && data.forecasts.length > 0) {
          console.log("神奈川の天気は" + data.forecasts[0].telop);
        } else {
          console.log("Forecast data is not available.");
        }
        weathertext =  "神奈川の天気は" + data.forecasts[0].telop;
      } catch (error) {
        console.error("Error fetching weather forecast data: ", error);
      }
    }

    // 関数を呼び出して天気データを取得
    getWeatherForecast();
  </script>

  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>
  <script type="module">
    // Fetch your API_KEY
    const API_KEY = API;

    import { GoogleGenerativeAI } from "@google/generative-ai";

    // Access your API key (see "Set up your API key" above)
    const genAI = new GoogleGenerativeAI(API_KEY);

    // ...

    // The Gemini 1.5 models are versatile and work with most use cases
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // ...
    async function run() {
      // ページ上のすべてのテキストエリア要素を取得
      const textareas = document.querySelectorAll("textarea");
      // テキストエリアの数を取得
      const numberOfTextareas = textareas.length - 1;
      let alltext = "";
      for (let i = 0; i < numberOfTextareas; ) {
        alltext += textareas[i].value;
        i++;
        if (i < numberOfTextareas) {
          alltext += "\n";
        }
      }
      console.log(alltext);
      const display = document.getElementById("output-area");

      const prompt =
        "以下の文章を日記の体裁で整えてください。日付は入れないでください。" +
        "\n" + weathertext +
        alltext;

      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      console.log(text);
      display.innerText = text;
    }

    const myfunc = document.getElementById("submit");
    myfunc.addEventListener("click", function () {
      run();
    });
  </script>
</html>
